import React, { useState } from "react";

export default function SDDatabase() {
  // States for login and user
  const [clearance, setClearance] = useState(null);
  const [codename, setCodename] = useState("");
  const [inputClearance, setInputClearance] = useState("");
  const [inputCodename, setInputCodename] = useState("");

  // SCP Search states
  const [scpSearch, setScpSearch] = useState("");
  const [scpInfo, setScpInfo] = useState("");
  const [scpLoading, setScpLoading] = useState(false);
  const [scpError, setScpError] = useState("");

  function handleLogin() {
    const lvl = parseInt(inputClearance);
    if ([3, 4, 5].includes(lvl) && inputCodename.trim() !== "") {
      setClearance(lvl);
      setCodename(inputCodename.trim());
    } else {
      alert("Invalid clearance (must be 3, 4, or 5) and non-empty codename.");
    }
  }

  async function fetchSCPInfo(scpId) {
    setScpLoading(true);
    setScpError("");
    setScpInfo("");

    let scpPage = scpId.toLowerCase();
    if (!scpPage.startsWith("scp-")) {
      scpPage = "scp-" + scpPage;
    }

    const wikiUrl = `https://scp-wiki.wikidot.com/${scpPage}`;

    try {
      // Replace this with your proxy URL that fetches the SCP Wiki page
      const proxyUrl = `/api/proxy?url=${encodeURIComponent(wikiUrl)}`;

      const res = await fetch(proxyUrl);
      if (!res.ok) throw new Error("Failed to fetch SCP data.");

      const text = await res.text();

      const parser = new DOMParser();
      const doc = parser.parseFromString(text, "text/html");
      const contentEl = doc.querySelector("#page-content");

      if (!contentEl) throw new Error("SCP content not found.");

      let contentText = contentEl.innerText.trim().slice(0, 2000);
      setScpInfo(contentText);
    } catch (err) {
      setScpError("Error fetching SCP info: " + err.message);
    } finally {
      setScpLoading(false);
    }
  }

  function handleScpSearch() {
    if (scpSearch.trim() === "") {
      alert("Enter SCP number or name to search.");
      return;
    }
    fetchSCPInfo(scpSearch.trim());
  }

  if (!clearance) {
    return (
      <div
        style={{
          height: "100vh",
          backgroundColor: "black",
          color: "white",
          display: "flex",
          flexDirection: "column",
          justifyContent: "center",
          alignItems: "center",
          fontFamily: "monospace",
          padding: 20,
        }}
      >
        <h1 style={{ fontSize: 64, marginBottom: 40 }}>SD DATABASE</h1>
        <input
          style={{
            marginBottom: 12,
            padding: 10,
            backgroundColor: "#111",
            color: "white",
            border: "1px solid white",
            borderRadius: 4,
            fontSize: 18,
            textAlign: "center",
            width: 250,
          }}
          placeholder="Enter Clearance Level (3,4,5)"
          value={inputClearance}
          onChange={(e) => {
            const val = e.target.value;
            if (val === "" || (/^[345]$/.test(val) && val.length <= 1)) {
              setInputClearance(val);
            }
          }}
        />
        <input
          style={{
            marginBottom: 20,
            padding: 10,
            backgroundColor: "#111",
            color: "white",
            border: "1px solid white",
            borderRadius: 4,
            fontSize: 18,
            textAlign: "center",
            width: 250,
          }}
          placeholder="Enter Codename"
          value={inputCodename}
          onChange={(e) => setInputCodename(e.target.value)}
        />
        <button
          onClick={handleLogin}
          style={{
            padding: "10px 40px",
            fontSize: 18,
            fontWeight: "bold",
            backgroundColor: "white",
            color: "black",
            borderRadius: 6,
            cursor: "pointer",
          }}
        >
          LOGIN
        </button>
      </div>
    );
  }

  // Main page after login
  return (
    <div
      style={{
        backgroundColor: "black",
        color: "white",
        minHeight: "100vh",
        padding: 20,
        fontFamily: "monospace",
        maxWidth: 900,
        margin: "auto",
      }}
    >
      {/* Header */}
      <header
        style={{
          display: "flex",
          justifyContent: "space-between",
          alignItems: "center",
          borderBottom: "1px solid white",
          paddingBottom: 12,
          marginBottom: 30,
        }}
      >
        <h1 style={{ fontSize: 48, fontWeight: "bold", letterSpacing: 4 }}>
          SD DATABASE
        </h1>
        <div style={{ fontSize: 18 }}>
          Codename: <strong>{codename}</strong> | Clearance Level: <strong>{clearance}</strong>
        </div>
      </header>

      {/* SD Lore */}
      <section style={{ marginBottom: 40 }}>
        <h2 style={{ fontSize: 28, borderBottom: "1px solid white", paddingBottom: 8 }}>
          SD Lore
        </h2>
        <p style={{ maxWidth: 700, color: "#ddd", lineHeight: 1.5, marginTop: 12 }}>
          The Security Department (SD) is a division of the SCP Foundation, consisting of agents
          tasked with guarding the Foundation's secret bases and containment facilities. Their job
          duties include preventing containment breaches (SCPs escaping from the site), keeping D-class
          personnel under control and forcing them to cooperate in laboratory experiments, and defending
          the site from external attacks by hostile forces (whether that be an enemy Group of Interest
          or something more anomalous).
        </p>
      </section>

      {/* SD Teams */}
      <section style={{ marginBottom: 40 }}>
        <h2 style={{ fontSize: 28, borderBottom: "1px solid white", paddingBottom: 8 }}>
          SD Teams
        </h2>

        {clearance >= 3 && (
          <>
            <h3 style={{ fontSize: 22, marginTop: 16 }}>Teams Accessible at L3+</h3>
            <ul style={{ marginLeft: 20, marginTop: 8, lineHeight: 1.4 }}>
              <li>
                <strong>Charlie:</strong> CDC and LCZ work.
              </li>
              <li>
                <strong>Quebec:</strong> MCZ and HCZ checkpoints and patrols.
              </li>
              <li>
                <strong>Xray:</strong> Guards AD checkpoint and VIPs.
              </li>
            </ul>
          </>
        )}

        {clearance >= 4 && (
          <>
            <h3 style={{ fontSize: 22, marginTop: 16 }}>Team Accessible at L4+</h3>
            <p style={{ marginTop: 8 }}>
              <strong>Hotel:</strong> Guards VIP but is way more skilled in PVP.
            </p>
          </>
        )}

        {clearance >= 5 && (
          <>
            <h3 style={{ fontSize: 22, marginTop: 16 }}>Team Accessible at L5+</h3>
            <p style={{ marginTop: 8 }}>
              <strong>STFO "Elite enforcers":</strong> A group from ████, similar to RESH-1 but in SD.
            </p>
          </>
        )}
      </section>

      {/* Personnel */}
      <section style={{ marginBottom: 40 }}>
        <h2 style={{ fontSize: 28, borderBottom: "1px solid white", paddingBottom: 8 }}>
          SD Personnel
        </h2>
        {clearance >= 4 ? (
          <ul style={{ marginLeft: 20, lineHeight: 1.6, maxWidth: 700 }}>
            <li>
              <a
                href="https://docs.google.com/document/d/19y8PjZXeLRLeM5YRb2OrC5P0a-y_LOkVk4Qapm9vlTI/edit?usp=sharing"
                target="_blank"
                rel="noopener noreferrer"
                style={{ color: "#ccc", textDecoration: "underline" }}
              >
                Warrant Officer "Ratchet"
              </a>
            </li>
            <li>
              <a
                href="https://docs.google.com/document/d/1TNidYCG7qQ5wLJbqSQqMU0RDAHTgP7LvIxFIUXUkkBs/edit?usp=sharing"
                target="_blank"
                rel="noopener noreferrer"
                style={{ color: "#ccc", textDecoration: "underline
